<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Inquiry Procedures API</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .field { margin: 10px 0; }
        select, button { padding: 8px; margin: 5px 0; }
        .results { background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .procedure-item { 
            background: white; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 3px;
            border-left: 4px solid #007bff;
        }
        .procedure-code { font-weight: bold; color: #007bff; }
        .procedure-amount { color: #28a745; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Inquiry Procedures API</h1>
        
        <div class="field">
            <label>Hospital:</label><br>
            <select id="hospital">
                <option value="">Select Hospital</option>
            </select>
        </div>
        
        <div class="field">
            <label>Surgical Category:</label><br>
            <select id="category">
                <option value="">Select Category (Optional)</option>
            </select>
        </div>
        
        <div class="field">
            <label>Payment Method:</label><br>
            <select id="paymentMethod">
                <option value="">Select Payment Method (Optional)</option>
            </select>
        </div>
        
        <button onclick="loadProcedures()">Load Procedures</button>
        
        <div class="results">
            <h3>Available Procedures:</h3>
            <div id="procedures"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        
        // Load initial data
        async function loadInitialData() {
            try {
                // Load hospitals
                const hospitalsRes = await fetch(`${API_BASE}/hospitals`);
                const hospitals = await hospitalsRes.json();
                const hospitalSelect = document.getElementById('hospital');
                hospitals.forEach(hospital => {
                    const option = document.createElement('option');
                    option.value = hospital._id;
                    option.textContent = hospital.shortName || hospital.legalName;
                    hospitalSelect.appendChild(option);
                });
                
                // Load categories
                const categoriesRes = await fetch(`${API_BASE}/categories`);
                const categoriesData = await categoriesRes.json();
                const categories = categoriesData.success ? categoriesData.data : categoriesData;
                const categorySelect = document.getElementById('category');
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = `${category.code} - ${category.description}`;
                    categorySelect.appendChild(option);
                });
                
                // Load payment methods
                const paymentRes = await fetch(`${API_BASE}/payment-types`);
                const paymentData = await paymentRes.json();
                const paymentMethods = paymentData.success ? paymentData.data : paymentData;
                const paymentSelect = document.getElementById('paymentMethod');
                paymentMethods.forEach(payment => {
                    const option = document.createElement('option');
                    option.value = payment._id;
                    option.textContent = `${payment.code} - ${payment.description}`;
                    paymentSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }
        
        // Load procedures based on filters
        async function loadProcedures() {
            const hospitalId = document.getElementById('hospital').value;
            const category = document.getElementById('category').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (!hospitalId) {
                alert('Please select a hospital first');
                return;
            }
            
            try {
                let url = `${API_BASE}/inquiries/procedures/${hospitalId}`;
                const params = new URLSearchParams();
                
                if (category) params.append('category', category);
                if (paymentMethod) params.append('paymentMethod', paymentMethod);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                console.log('Fetching:', url);
                const response = await fetch(url);
                const data = await response.json();
                
                const proceduresDiv = document.getElementById('procedures');
                
                if (data.success && data.data.length > 0) {
                    proceduresDiv.innerHTML = data.data.map(procedure => `
                        <div class="procedure-item">
                            <div class="procedure-code">${procedure.code} - ${procedure.name}</div>
                            <div>Category: ${procedure.categoryId.code} - ${procedure.categoryId.description}</div>
                            <div>Payment Type: ${procedure.paymentTypeId.code} - ${procedure.paymentTypeId.description}</div>
                            <div class="procedure-amount">Amount: ${procedure.amount} ${procedure.currency}</div>
                        </div>
                    `).join('');
                } else {
                    proceduresDiv.innerHTML = `
                        <p style="text-align: center; color: #666;">
                            ${data.success ? 'No procedures found for the selected filters' : 'Error: ' + data.message}
                        </p>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading procedures:', error);
                document.getElementById('procedures').innerHTML = `
                    <p style="color: red;">Error loading procedures: ${error.message}</p>
                `;
            }
        }
        
        // Load initial data on page load
        loadInitialData();
    </script>
</body>
</html>
