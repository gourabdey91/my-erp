<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GST Amount Staging Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .result { 
            background-color: #f0f8ff; 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 3px; 
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error { 
            background-color: #ffe6e6; 
            color: red; 
        }
        .success { 
            background-color: #e6ffe6; 
            color: green; 
        }
        .warning { 
            background-color: #fff3cd; 
            color: #856404;
        }
        button { 
            background-color: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { 
            background-color: #0056b3; 
        }
        .gst-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 14px;
        }
        .gst-table th, .gst-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        .gst-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .gst-table .item-name {
            text-align: left;
            font-weight: bold;
        }
        .verification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            margin: 3px 0;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        .verification-pass {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .verification-fail {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üßÆ GST Amount Staging Test</h1>
        <p><strong>Purpose:</strong> Verify that total GST amount (`gstAmount`) field is properly staged in database.</p>

        <div class="test-section">
            <h3>Step 1: Create Inquiry with GST Breakdown</h3>
            <button onclick="createGSTTestInquiry()">üÜï Create GST Test Inquiry</button>
            <div id="step1Result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Step 2: Verify GST Staging in Database</h3>
            <button onclick="verifyGSTStaging()">üîç Check GST Staging</button>
            <div id="step2Result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>Step 3: Update and Re-verify</h3>
            <button onclick="updateAndReverify()">üîÑ Update & Re-verify</button>
            <div id="step3Result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>üìä GST Amount Validation Summary</h3>
            <div id="summaryResult" class="result"></div>
        </div>
    </div>

    <script>
        let testInquiryId = null;
        let testResults = {
            creation: false,
            staging: false,
            update: false
        };

        async function createGSTTestInquiry() {
            const resultDiv = document.getElementById('step1Result');
            
            try {
                const testData = {
                    inquiryNumber: `GST-STAGING-TEST-${Date.now()}`,
                    hospital: '64a1b2c3d4e5f6789012345a',
                    procedure: '64a1b2c3d4e5f6789012345b',
                    patientName: 'GST Staging Test Patient',
                    patientUHID: 'GST001',
                    limit: {
                        amount: 100000,
                        currency: 'INR'
                    },
                    items: [
                        {
                            serialNumber: 1,
                            materialNumber: 'STENT001',
                            materialDescription: 'Cardiac Stent',
                            unitRate: 50000,
                            quantity: 1,
                            gstPercentage: 18,
                            gstAmount: 9000,      // Total GST (18% of 50000)
                            cgstAmount: 4500,     // 50% of GST for same state
                            sgstAmount: 4500,     // 50% of GST for same state
                            igstAmount: 0,        // 0 for same state
                            totalAmount: 59000,   // 50000 + 9000
                            discountPercentage: 0,
                            unit: 'PC'
                        },
                        {
                            serialNumber: 2,
                            materialNumber: 'GUIDE001',
                            materialDescription: 'Guide Wire',
                            unitRate: 15000,
                            quantity: 2,
                            gstPercentage: 12,
                            gstAmount: 3600,      // Total GST (12% of 30000)
                            cgstAmount: 1800,     // 50% of GST
                            sgstAmount: 1800,     // 50% of GST
                            igstAmount: 0,        // 0 for same state
                            totalAmount: 33600,   // 30000 + 3600
                            discountPercentage: 0,
                            unit: 'PC'
                        },
                        {
                            serialNumber: 3,
                            materialNumber: 'BALLOON001',
                            materialDescription: 'PTCA Balloon',
                            unitRate: 8000,
                            quantity: 1,
                            gstPercentage: 5,
                            gstAmount: 400,       // Total GST (5% of 8000)
                            cgstAmount: 200,      // 50% of GST
                            sgstAmount: 200,      // 50% of GST
                            igstAmount: 0,        // 0 for same state
                            totalAmount: 8400,    // 8000 + 400
                            discountPercentage: 0,
                            unit: 'PC'
                        }
                    ]
                };

                const response = await fetch('/api/inquiries', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const inquiry = await response.json();
                    testInquiryId = inquiry._id;
                    testResults.creation = true;
                    
                    let itemsTable = '<table class="gst-table">';
                    itemsTable += '<tr><th>Item</th><th>Unit Rate</th><th>Qty</th><th>GST%</th><th>Total GST</th><th>CGST</th><th>SGST</th><th>IGST</th><th>Total</th></tr>';
                    
                    inquiry.items.forEach(item => {
                        itemsTable += `<tr>
                            <td class="item-name">${item.materialDescription}</td>
                            <td>‚Çπ${item.unitRate}</td>
                            <td>${item.quantity}</td>
                            <td>${item.gstPercentage}%</td>
                            <td>‚Çπ${item.gstAmount || 0}</td>
                            <td>‚Çπ${item.cgstAmount}</td>
                            <td>‚Çπ${item.sgstAmount}</td>
                            <td>‚Çπ${item.igstAmount}</td>
                            <td>‚Çπ${item.totalAmount}</td>
                        </tr>`;
                    });
                    itemsTable += '</table>';
                    
                    resultDiv.innerHTML = `‚úÖ SUCCESS: GST test inquiry created
ID: ${inquiry._id}
Total Inquiry Amount: ‚Çπ${inquiry.totalInquiryAmount}

${itemsTable}`;
                    resultDiv.className = 'result success';
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `‚ùå ERROR: ${error}`;
                    resultDiv.className = 'result error';
                    testResults.creation = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå ERROR: ${error.message}`;
                resultDiv.className = 'result error';
                testResults.creation = false;
            }
        }

        async function verifyGSTStaging() {
            const resultDiv = document.getElementById('step2Result');
            
            if (!testInquiryId) {
                resultDiv.innerHTML = '‚ö†Ô∏è Please create test inquiry first';
                resultDiv.className = 'result warning';
                return;
            }

            try {
                const response = await fetch(`/api/inquiries/${testInquiryId}`);
                
                if (response.ok) {
                    const inquiry = await response.json();
                    
                    let verificationResults = [];
                    let allPassed = true;
                    
                    // Expected values
                    const expectedValues = [
                        { name: 'Cardiac Stent', gstAmount: 9000, cgstAmount: 4500, sgstAmount: 4500, igstAmount: 0 },
                        { name: 'Guide Wire', gstAmount: 3600, cgstAmount: 1800, sgstAmount: 1800, igstAmount: 0 },
                        { name: 'PTCA Balloon', gstAmount: 400, cgstAmount: 200, sgstAmount: 200, igstAmount: 0 }
                    ];
                    
                    inquiry.items.forEach((item, index) => {
                        const expected = expectedValues[index];
                        
                        // Check if gstAmount field exists and matches
                        const gstAmountExists = item.gstAmount !== undefined;
                        const gstAmountCorrect = Math.abs((item.gstAmount || 0) - expected.gstAmount) < 0.01;
                        const gstSumMatches = Math.abs(((item.cgstAmount || 0) + (item.sgstAmount || 0) + (item.igstAmount || 0)) - expected.gstAmount) < 0.01;
                        
                        verificationResults.push({
                            item: expected.name,
                            test: 'gstAmount field exists',
                            passed: gstAmountExists,
                            value: gstAmountExists ? '‚úÖ Present' : '‚ùå Missing'
                        });
                        
                        verificationResults.push({
                            item: expected.name,
                            test: 'gstAmount value correct',
                            passed: gstAmountCorrect,
                            value: `Expected: ‚Çπ${expected.gstAmount}, Got: ‚Çπ${item.gstAmount || 0}`
                        });
                        
                        verificationResults.push({
                            item: expected.name,
                            test: 'GST sum matches gstAmount',
                            passed: gstSumMatches,
                            value: `CGST + SGST + IGST = ‚Çπ${(item.cgstAmount || 0) + (item.sgstAmount || 0) + (item.igstAmount || 0)}`
                        });
                        
                        if (!gstAmountExists || !gstAmountCorrect || !gstSumMatches) {
                            allPassed = false;
                        }
                    });
                    
                    testResults.staging = allPassed;
                    
                    let resultHTML = `üîç GST STAGING VERIFICATION:\n\n`;
                    
                    verificationResults.forEach(result => {
                        const statusClass = result.passed ? 'verification-pass' : 'verification-fail';
                        const statusIcon = result.passed ? '‚úÖ' : '‚ùå';
                        resultHTML += `<div class="${statusClass}">${result.item} - ${result.test}: ${statusIcon} ${result.value}</div>`;
                    });
                    
                    resultHTML += `\n\nOverall Result: ${allPassed ? '‚úÖ ALL CHECKS PASSED' : '‚ùå SOME CHECKS FAILED'}`;
                    
                    resultDiv.innerHTML = resultHTML;
                    resultDiv.className = allPassed ? 'result success' : 'result error';
                } else {
                    resultDiv.innerHTML = '‚ùå ERROR: Could not fetch inquiry';
                    resultDiv.className = 'result error';
                    testResults.staging = false;
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå ERROR: ${error.message}`;
                resultDiv.className = 'result error';
                testResults.staging = false;
            }
        }

        async function updateAndReverify() {
            const resultDiv = document.getElementById('step3Result');
            
            if (!testInquiryId) {
                resultDiv.innerHTML = '‚ö†Ô∏è Please create test inquiry first';
                resultDiv.className = 'result warning';
                return;
            }

            try {
                // Update with new item to test GST calculation
                const updateResponse = await fetch(`/api/inquiries/${testInquiryId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        items: [
                            {
                                serialNumber: 1,
                                materialNumber: 'STENT001',
                                materialDescription: 'Cardiac Stent',
                                unitRate: 60000,      // Changed price
                                quantity: 1,
                                gstPercentage: 18,
                                gstAmount: 10800,     // New GST amount
                                cgstAmount: 5400,
                                sgstAmount: 5400,
                                igstAmount: 0,
                                totalAmount: 70800,
                                discountPercentage: 0,
                                unit: 'PC'
                            }
                        ]
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error('Failed to update inquiry');
                }

                // Verify the update
                const verifyResponse = await fetch(`/api/inquiries/${testInquiryId}`);
                
                if (verifyResponse.ok) {
                    const inquiry = await verifyResponse.json();
                    const item = inquiry.items[0];
                    
                    const gstAmountCorrect = Math.abs((item.gstAmount || 0) - 10800) < 0.01;
                    const cgstCorrect = Math.abs((item.cgstAmount || 0) - 5400) < 0.01;
                    const sgstCorrect = Math.abs((item.sgstAmount || 0) - 5400) < 0.01;
                    const totalCorrect = Math.abs((item.totalAmount || 0) - 70800) < 0.01;
                    
                    const updateSuccess = gstAmountCorrect && cgstCorrect && sgstCorrect && totalCorrect;
                    testResults.update = updateSuccess;
                    
                    let resultHTML = `üîÑ UPDATE VERIFICATION:\n\n`;
                    resultHTML += `Updated Item: ${item.materialDescription}\n`;
                    resultHTML += `Unit Rate: ‚Çπ${item.unitRate} ${item.unitRate === 60000 ? '‚úÖ' : '‚ùå'}\n`;
                    resultHTML += `GST Amount: ‚Çπ${item.gstAmount || 0} ${gstAmountCorrect ? '‚úÖ' : '‚ùå'} (Expected: ‚Çπ10800)\n`;
                    resultHTML += `CGST: ‚Çπ${item.cgstAmount || 0} ${cgstCorrect ? '‚úÖ' : '‚ùå'} (Expected: ‚Çπ5400)\n`;
                    resultHTML += `SGST: ‚Çπ${item.sgstAmount || 0} ${sgstCorrect ? '‚úÖ' : '‚ùå'} (Expected: ‚Çπ5400)\n`;
                    resultHTML += `Total: ‚Çπ${item.totalAmount || 0} ${totalCorrect ? '‚úÖ' : '‚ùå'} (Expected: ‚Çπ70800)\n\n`;
                    resultHTML += `Update Result: ${updateSuccess ? '‚úÖ SUCCESS' : '‚ùå FAILED'}`;
                    
                    resultDiv.innerHTML = resultHTML;
                    resultDiv.className = updateSuccess ? 'result success' : 'result error';
                    
                    updateSummary();
                } else {
                    throw new Error('Failed to verify updated inquiry');
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå ERROR: ${error.message}`;
                resultDiv.className = 'result error';
                testResults.update = false;
            }
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summaryResult');
            
            const allTestsPassed = testResults.creation && testResults.staging && testResults.update;
            
            let summary = `üìä GST AMOUNT STAGING TEST SUMMARY:

üîç Test Inquiry ID: ${testInquiryId || 'Not created'}
üìÖ Test Completed: ${new Date().toLocaleString()}

Test Results:
‚Ä¢ Inquiry Creation: ${testResults.creation ? '‚úÖ PASSED' : '‚ùå FAILED'}
‚Ä¢ GST Staging Verification: ${testResults.staging ? '‚úÖ PASSED' : '‚ùå FAILED'}
‚Ä¢ Update & Re-verification: ${testResults.update ? '‚úÖ PASSED' : '‚ùå FAILED'}

Overall Result: ${allTestsPassed ? 'üéâ ALL TESTS PASSED' : '‚ùå SOME TESTS FAILED'}

Key Validations:
‚úì gstAmount field exists in database schema
‚úì gstAmount value correctly calculated and stored
‚úì gstAmount equals sum of CGST + SGST + IGST
‚úì Updates preserve GST amount integrity
‚úì Backend and frontend maintain GST amount consistency

${allTestsPassed ? 
    'üéâ The GST amount staging fix is working perfectly! Total GST amounts are properly stored and retrieved from the database.' :
    '‚ö†Ô∏è GST amount staging needs attention. Some validations failed.'}`;
            
            summaryDiv.innerHTML = summary;
            summaryDiv.className = allTestsPassed ? 'result success' : 'result error';
        }
    </script>
</body>
</html>
